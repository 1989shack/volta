<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <!--
  all built-in variables: http://wixtoolset.org/documentation/manual/v3/bundle/bundle_built_in_variables.html
  -->

  <Product Id="10F5B6C9-7D75-411E-8686-3964129D022A"
           Name="Nodeup"
           Manufacturer="The Nodeup Maintainers"
           UpgradeCode="42A39E14-335A-4464-AA37-17FDA38FA377"
           Language="1033"
           Codepage="1252"
           Version="0.1.0">

    <!--
    per-machine scope:
    https://www.joyofsetup.com/2008/04/01/new-wix-feature-setting-package-installation-scope/
    -->
    <Package Id="*"
             Keywords="Installer"
             Description="Nodeup installer"
             Manufacturer="The Nodeup Maintainers"
             InstallerVersion="200"
             InstallScope="perMachine"
             Platform="x64"
             Languages="1033"
             SummaryCodepage="1252"
             Compressed="yes"/>
    <MajorUpgrade DowngradeErrorMessage="A newer version of Nodeup is already installed." />
    <Media Id="1"
           Cabinet="Nodeup.cab"
           EmbedCab="yes"/>

    <!-- creating empty directories: https://www.packtpub.com/mapt/book/application_development/9781849513722/2/ch02lvl1sec21/creating-an-empty-folder -->
    <DirectoryRef Id="ToolchainDir">
      <Component Id="CreateToolchainDir"
                 Guid="56E719E4-78BB-4841-8912-D471ADE84159"
                 Win64="yes"
                 KeyPath="yes">
        <CreateFolder />
        <!-- env vars: https://stackoverflow.com/questions/1931586/can-anyone-give-me-a-example-of-modifying-windows-environment-system-variables-i -->
        <Environment Id="PATH" Name="PATH" Value="[ProgramFiles64Folder]Nodeup;[ProgramFiles64Folder]Nodeup\toolchain" Permanent="no" Part="first" Action="set" System="yes" />
        <RemoveFile Id="RemoveToolchainHardLinks" Directory="ToolchainDir" Name="*.exe" On="uninstall" />
        <RemoveFolder Id="RemoveToolchainDir" Directory="ToolchainDir" On="uninstall" />
      </Component>
    </DirectoryRef>

    <!--
    https://stackoverflow.com/questions/38370417/windows-installer-not-deleting-all-files-on-uninstall
    https://pkisensee.wordpress.com/2015/10/06/windows-installer-removing-folders/
    -->
    <DirectoryRef Id='DataDir'>
      <Component Id="RemoveVersionsNodeDir"
                 Guid="*"
                 Win64="yes">
        <RegistryKey Root="HKLM" Key="Software\Nodeup">
          <RegistryValue Name="NodeVersions"
                         Type="string"
                         Value="[VersionsNodeDir]"
                         Action="write"
                         KeyPath="yes" />
        </RegistryKey>
        <CreateFolder Directory="VersionsNodeDir" />
        <util:RemoveFolderEx Property="FINDVERSIONSNODEDIR" On="uninstall" />
        <RemoveFolder Id="VersionsNodeDir" Directory="VersionsNodeDir" On="uninstall" />
      </Component>
    </DirectoryRef>

    <!--
    Secure = "yes": https://stackoverflow.com/questions/25011050/wix-removefolderex-not-working
    -->
    <Property Id="FINDVERSIONSNODEDIR" Secure="yes">
      <RegistrySearch Id="RegistrySearchNodeVersions" Type="raw" Root="HKLM" Key="Software\Nodeup" Name="NodeVersions" />
    </Property>

    <!-- creating empty directories: https://www.packtpub.com/mapt/book/application_development/9781849513722/2/ch02lvl1sec21/creating-an-empty-folder -->
    <DirectoryRef Id="VersionsNodeDir">
      <Component Id="CreateVersionsNodeDir"
                 Guid="D142AE24-C7AB-43C3-81B4-62AC4FCB26D1"
                 Win64="yes"
                 KeyPath="yes">
        <CreateFolder />
        <RemoveFolder Id="RemoveVersionsDir" Directory="VersionsDir" On="uninstall" />
      </Component>
    </DirectoryRef>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder" Name="PFiles">
        <Directory Id="INSTALLDIR" Name="Nodeup">
          <Component Id="NodeupExecutable"
                     Guid="F1FBF564-E557-47A8-96D3-EBD4ED39AF95"
                     Win64="yes">
            <File Id="NodeupEXE"
                  Name="nodeup.exe"
                  DiskId="1"
                  Source="target\release\nodeup.exe"
                  KeyPath="yes">
            </File>
            <RemoveFolder Id="RemoveInstallDir" Directory="INSTALLDIR" On="uninstall" />
          </Component>

          <Directory Id="ToolchainDir" Name="toolchain" />
        </Directory>
      </Directory>

      <Directory Id="CommonAppDataFolder" Name="PData">
        <Directory Id="DataDir" Name="Nodeup">
          <Component Id="BinstubExecutable"
                     Guid="83786F85-45AF-4F3F-ACA2-8D6A83C21729"
                     Win64="yes">
            <File Id="BinstubEXE"
                  Name="binstub.exe"
                  DiskId="1"
                  Source="target\release\binstub.exe"
                  KeyPath="yes">
            </File>
            <RemoveFolder Id="RemoveDataDir" Directory="DataDir" On="uninstall" />
          </Component>

          <Directory Id="VersionsDir" Name="versions">
            <Directory Id="VersionsNodeDir" Name="node" />
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <!--
    deferred semantics: https://www.symantec.com/connect/blogs/basic-differences-execute-immediate-and-execute-deferred-ca
    quiet execution: http://wixtoolset.org/documentation/manual/v3/customactions/qtexec.html
    -->
    <CustomAction Id="MakeHardLink_set"
                  Property="MakeHardLink"
                  Value='"[SystemFolder]cmd.exe" /C FOR %G IN (node.exe npm.exe npx.exe) DO mklink /H "[ProgramFiles64Folder]Nodeup\toolchain\%G" "[CommonAppDataFolder]Nodeup\binstub.exe"'
                  Execute='immediate' />
    <CustomAction Id="MakeHardLink"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Return="ignore"
                  Impersonate="no" />

    <InstallExecuteSequence>
      <!-- conditions: https://stackoverflow.com/questions/537584/how-to-execute-custom-action-only-in-install-not-uninstall -->
      <Custom Action="MakeHardLink_set" After="InstallFiles">NOT REMOVE</Custom>
      <Custom Action="MakeHardLink" After="MakeHardLink_set">NOT REMOVE</Custom>
    </InstallExecuteSequence>

    <Feature Id="Complete">
      <ComponentRef Id='NodeupExecutable'/>
      <ComponentRef Id='BinstubExecutable'/>
      <ComponentRef Id='CreateToolchainDir'/>
      <ComponentRef Id='CreateVersionsNodeDir'/>
      <ComponentRef Id='RemoveVersionsNodeDir'/>
    </Feature>
  </Product>
</Wix>
